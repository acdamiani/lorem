#include <X11/Xatom.h>
#include <X11/Xlib.h>
#include <stdio.h>
#include <string.h>
#include <time.h>

unsigned char lorem[] = {
    0x4c, 0x6f, 0x72, 0x65, 0x6d, 0x20, 0x69, 0x70, 0x73, 0x75, 0x6d, 0x20,
    0x64, 0x6f, 0x6c, 0x6f, 0x72, 0x20, 0x73, 0x69, 0x74, 0x20, 0x61, 0x6d,
    0x65, 0x74, 0x2c, 0x20, 0x63, 0x6f, 0x6e, 0x73, 0x65, 0x63, 0x74, 0x65,
    0x74, 0x75, 0x72, 0x20, 0x61, 0x64, 0x69, 0x70, 0x69, 0x73, 0x63, 0x69,
    0x6e, 0x67, 0x20, 0x65, 0x6c, 0x69, 0x74, 0x2e, 0x20, 0x50, 0x72, 0x6f,
    0x69, 0x6e, 0x20, 0x65, 0x67, 0x65, 0x73, 0x74, 0x61, 0x73, 0x20, 0x64,
    0x69, 0x61, 0x6d, 0x20, 0x73, 0x65, 0x64, 0x20, 0x6c, 0x6f, 0x62, 0x6f,
    0x72, 0x74, 0x69, 0x73, 0x20, 0x75, 0x6c, 0x74, 0x72, 0x69, 0x63, 0x65,
    0x73, 0x2e, 0x20, 0x4d, 0x61, 0x65, 0x63, 0x65, 0x6e, 0x61, 0x73, 0x20,
    0x61, 0x75, 0x67, 0x75, 0x65, 0x20, 0x6c, 0x69, 0x62, 0x65, 0x72, 0x6f,
    0x2c, 0x20, 0x63, 0x6f, 0x6e, 0x64, 0x69, 0x6d, 0x65, 0x6e, 0x74, 0x75,
    0x6d, 0x20, 0x76, 0x65, 0x6c, 0x20, 0x73, 0x6f, 0x6c, 0x6c, 0x69, 0x63,
    0x69, 0x74, 0x75, 0x64, 0x69, 0x6e, 0x20, 0x6e, 0x65, 0x63, 0x2c, 0x20,
    0x73, 0x6f, 0x64, 0x61, 0x6c, 0x65, 0x73, 0x20, 0x61, 0x63, 0x20, 0x73,
    0x61, 0x70, 0x69, 0x65, 0x6e, 0x2e, 0x20, 0x43, 0x72, 0x61, 0x73, 0x20,
    0x65, 0x67, 0x65, 0x74, 0x20, 0x67, 0x72, 0x61, 0x76, 0x69, 0x64, 0x61,
    0x20, 0x6c, 0x65, 0x6f, 0x2c, 0x20, 0x76, 0x69, 0x74, 0x61, 0x65, 0x20,
    0x62, 0x69, 0x62, 0x65, 0x6e, 0x64, 0x75, 0x6d, 0x20, 0x61, 0x6e, 0x74,
    0x65, 0x2e, 0x20, 0x44, 0x75, 0x69, 0x73, 0x20, 0x74, 0x72, 0x69, 0x73,
    0x74, 0x69, 0x71, 0x75, 0x65, 0x20, 0x63, 0x75, 0x72, 0x73, 0x75, 0x73,
    0x20, 0x6d, 0x61, 0x67, 0x6e, 0x61, 0x20, 0x6e, 0x6f, 0x6e, 0x20, 0x63,
    0x6f, 0x6d, 0x6d, 0x6f, 0x64, 0x6f, 0x2e, 0x20, 0x43, 0x75, 0x72, 0x61,
    0x62, 0x69, 0x74, 0x75, 0x72, 0x20, 0x6e, 0x65, 0x63, 0x20, 0x69, 0x70,
    0x73, 0x75, 0x6d, 0x20, 0x73, 0x63, 0x65, 0x6c, 0x65, 0x72, 0x69, 0x73,
    0x71, 0x75, 0x65, 0x2c, 0x20, 0x63, 0x6f, 0x6d, 0x6d, 0x6f, 0x64, 0x6f,
    0x20, 0x61, 0x6e, 0x74, 0x65, 0x20, 0x69, 0x64, 0x2c, 0x20, 0x63, 0x6f,
    0x6e, 0x67, 0x75, 0x65, 0x20, 0x66, 0x65, 0x6c, 0x69, 0x73, 0x2e, 0x20,
    0x44, 0x6f, 0x6e, 0x65, 0x63, 0x20, 0x65, 0x72, 0x61, 0x74, 0x20, 0x6a,
    0x75, 0x73, 0x74, 0x6f, 0x2c, 0x20, 0x74, 0x65, 0x6d, 0x70, 0x75, 0x73,
    0x20, 0x73, 0x69, 0x74, 0x20, 0x61, 0x6d, 0x65, 0x74, 0x20, 0x6c, 0x65,
    0x6f, 0x20, 0x69, 0x6d, 0x70, 0x65, 0x72, 0x64, 0x69, 0x65, 0x74, 0x2c,
    0x20, 0x70, 0x6f, 0x72, 0x74, 0x61, 0x20, 0x74, 0x65, 0x6d, 0x70, 0x6f,
    0x72, 0x20, 0x74, 0x65, 0x6c, 0x6c, 0x75, 0x73, 0x2e, 0x20, 0x50, 0x68,
    0x61, 0x73, 0x65, 0x6c, 0x6c, 0x75, 0x73, 0x20, 0x65, 0x74, 0x20, 0x61,
    0x72, 0x63, 0x75, 0x20, 0x61, 0x20, 0x6e, 0x69, 0x73, 0x6c, 0x20, 0x62,
    0x6c, 0x61, 0x6e, 0x64, 0x69, 0x74, 0x20, 0x70, 0x72, 0x65, 0x74, 0x69,
    0x75, 0x6d, 0x20, 0x71, 0x75, 0x69, 0x73, 0x20, 0x6e, 0x6f, 0x6e, 0x20,
    0x6e, 0x69, 0x73, 0x6c, 0x2e, 0x20, 0x4e, 0x75, 0x6e, 0x63, 0x20, 0x76,
    0x65, 0x73, 0x74, 0x69, 0x62, 0x75, 0x6c, 0x75, 0x6d, 0x20, 0x6e, 0x69,
    0x73, 0x69, 0x20, 0x76, 0x65, 0x6c, 0x20, 0x61, 0x63, 0x63, 0x75, 0x6d,
    0x73, 0x61, 0x6e, 0x20, 0x75, 0x6c, 0x74, 0x72, 0x69, 0x63, 0x69, 0x65,
    0x73, 0x2e, 0x20, 0x49, 0x6e, 0x74, 0x65, 0x67, 0x65, 0x72, 0x20, 0x66,
    0x69, 0x6e, 0x69, 0x62, 0x75, 0x73, 0x20, 0x70, 0x75, 0x72, 0x75, 0x73,
    0x20, 0x65, 0x74, 0x20, 0x6a, 0x75, 0x73, 0x74, 0x6f, 0x20, 0x63, 0x6f,
    0x6e, 0x67, 0x75, 0x65, 0x2c, 0x20, 0x75, 0x74, 0x20, 0x61, 0x75, 0x63,
    0x74, 0x6f, 0x72, 0x20, 0x61, 0x72, 0x63, 0x75, 0x20, 0x63, 0x75, 0x72,
    0x73, 0x75, 0x73, 0x2e, 0x20, 0x56, 0x65, 0x73, 0x74, 0x69, 0x62, 0x75,
    0x6c, 0x75, 0x6d, 0x20, 0x61, 0x20, 0x75, 0x72, 0x6e, 0x61, 0x20, 0x61,
    0x63, 0x20, 0x64, 0x75, 0x69, 0x20, 0x66, 0x61, 0x75, 0x63, 0x69, 0x62,
    0x75, 0x73, 0x20, 0x61, 0x75, 0x63, 0x74, 0x6f, 0x72, 0x2e, 0x0a};
unsigned int lorem_len = 599;

void send_no(Display *dpy, XSelectionRequestEvent *sev) {
  XSelectionEvent ssev;
  char *an;

  an = XGetAtomName(dpy, sev->target);
  printf("Denying request of type '%s'\n", an);
  if (an)
    XFree(an);

  /* All of these should match the values of the request. */
  ssev.type = SelectionNotify;
  ssev.requestor = sev->requestor;
  ssev.selection = sev->selection;
  ssev.target = sev->target;
  ssev.property = None; /* signifies "nope" */
  ssev.time = sev->time;

  XSendEvent(dpy, sev->requestor, True, NoEventMask, (XEvent *)&ssev);
  XFlush(dpy);
}

void send_string(Display *dpy, XSelectionRequestEvent *sev, Atom utf8) {
  XSelectionEvent ssev;
  char *an;
  char *now = (char *)lorem;

  an = XGetAtomName(dpy, sev->property);
  printf("Sending data to window 0x%lx, property '%s'\n", sev->requestor, an);
  if (an)
    XFree(an);

  XChangeProperty(dpy, sev->requestor, sev->property, utf8, 8, PropModeReplace,
                  (unsigned char *)now, strlen(now));

  ssev.type = SelectionNotify;
  ssev.requestor = sev->requestor;
  ssev.selection = sev->selection;
  ssev.target = sev->target;
  ssev.property = sev->property;
  ssev.time = sev->time;

  XSendEvent(dpy, sev->requestor, True, NoEventMask, (XEvent *)&ssev);
  XFlush(dpy);
}

void send_targets(Display *dpy, XSelectionRequestEvent *sev, Atom *targets,
                  int ntargets) {
  XSelectionEvent ssev;
  char *an;

  an = XGetAtomName(dpy, sev->property);
  printf("Sending target data to window 0x%lx, property '%s'\n", sev->requestor,
         an);
  if (an)
    XFree(an);

  XChangeProperty(dpy, sev->requestor, sev->property, XA_ATOM, 32,
                  PropModeReplace, (const unsigned char *)targets, ntargets);

  ssev.type = SelectionNotify;
  ssev.requestor = sev->requestor;
  ssev.selection = sev->selection;
  ssev.target = sev->target;
  ssev.property = sev->property;
  ssev.time = sev->time;

  XSendEvent(dpy, sev->requestor, True, NoEventMask, (XEvent *)&ssev);
  XFlush(dpy);
}

int main() {
  Display *dpy;
  Window owner, root;
  int screen;
  Atom sel, targets;
  XEvent ev;
  XSelectionRequestEvent *sev;

  dpy = XOpenDisplay(NULL);
  if (!dpy) {
    fprintf(stderr, "Could not open X display\n");
    return 1;
  }

  screen = DefaultScreen(dpy);
  root = RootWindow(dpy, screen);

  /* We need a window to receive messages from other clients. */
  owner = XCreateSimpleWindow(dpy, root, -10, -10, 1, 1, 0, 0, 0);

  sel = XInternAtom(dpy, "CLIPBOARD", False);
  targets = XInternAtom(dpy, "TARGETS", False);

  /* Claim ownership of the clipboard. */
  XSetSelectionOwner(dpy, sel, owner, CurrentTime);
  Atom valid_targets[10];

  char *valid_target_names[] = {
      "TIMESTAMP",    "TARGETS",     "MULTIPLE",
      "SAVE_TARGETS", "UTF8_STRING", "COMPOUND_TEXT",
      "TEXT",         "STRING",      "text/plain;charset=utf-8",
      "text/plain"};

  XInternAtoms(dpy, valid_target_names, 10, False, valid_targets);

  for (;;) {
    XNextEvent(dpy, &ev);

    switch (ev.type) {
    case PropertyNotify:
      printf("Check\n");
      break;
    case SelectionClear:
      printf("Lost selection ownership\n");
      return 1;
      break;
    case SelectionRequest:
      sev = (XSelectionRequestEvent *)&ev.xselectionrequest;
      printf("Requestor: 0x%lx\n", sev->requestor);

      char *an;
      an = XGetAtomName(dpy, sev->target);

      int is_string_target = 0;

      for (int i = 0; i < 10; i++) {
        if (!strcmp(an, valid_target_names[i]))
          is_string_target = i + 1;
      }

      if (an)
        XFree(an);

      if (sev->target == targets && sev->property != None) {
        send_targets(dpy, sev, valid_targets, 10);
      } else if (is_string_target && sev->property != None) {
        send_string(dpy, sev, valid_targets[is_string_target - 1]);
        return 0;
      } else {
        send_no(dpy, sev);
      }

      break;
    }
  }
}
